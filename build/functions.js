(()=>{"use strict";const t=new Map;let e=[],o=!1;function r(t,r){const s=new Promise(((o,n)=>{e.push({asset_id:t,dateTime:r,resolve:o,reject:n})}));return o||(o=!0,setTimeout(n,100)),s}async function n(){const r=864e5,n=localStorage.getItem("aeso-api-key")??"",s=e;e=[],o=!1;const a=new Map;for(const t of s){let e=a.get(t.asset_id);null==e&&(e=new Map,a.set(t.asset_id,e));let o=e.get(t.dateTime.getTime());null==o&&(o=[],e.set(t.dateTime.getTime(),o)),o.push({resolve:t.resolve,reject:t.reject})}const l=[],c=[];for(const[e,o]of a.entries()){const s=Array.from(o.entries()).sort(((t,e)=>t[0]-e[0]));let a=null,i=null,u=[];for(let o=0;o<s.length;o++){const d=s[o][0];if(u=u.concat(s[o][1]),null==a&&(a=d),null==i&&(i=d),24*(Math.floor((d-a)/r)+1)>8e4||Math.floor((d-i)/r)>5||o==s.length-1){const o=new Date(a),r=new Date(d),s=o.getUTCFullYear().toFixed(),p=(o.getUTCMonth()+1).toFixed().padStart(2,"0"),f=o.getUTCDate().toFixed().padStart(2,"0"),g=r.getUTCFullYear().toFixed(),h=(r.getUTCMonth()+1).toFixed().padStart(2,"0"),m=r.getUTCDate().toFixed().padStart(2,"0");let w;w=s==g&&p==h&&f==m?`http://localhost:38820/https://api.aeso.ca/report/v1/meteredvolume/details?startDate=${s}-${p}-${f}&asset_ID=${e}`:`http://localhost:38820/https://api.aeso.ca/report/v1/meteredvolume/details?startDate=${s}-${p}-${f}&endDate=${g}-${h}-${m}&asset_ID=${e}`;const T=u;u=[],c.push(new Promise((async(e,o)=>{try{console.log("Request to",w);const o=await fetch(w,{headers:{"X-API-Key":n}}),r=await o.json();for(const e of r.return)for(const o of e.asset_list){let e=t.get(o.asset_ID);null==e&&(e=new Map,t.set(o.asset_ID,e));for(const t of o.metered_volume_list)e.set(t.begin_date_mpt,parseFloat(t.metered_volume))}for(const t of T)t.resolve();e()}catch(t){for(const e of T)e.reject(t);o(t)}}))),l.push(w),a=null,i=null}i=d}}await Promise.allSettled(c)}let s=new Map,a=!1;async function l(){a=!1;const t=new Map(s);s.clear();const e=Array.from(t.entries()).sort(((t,e)=>t[0].getTime()-e[0].getTime())),o=new Map;let r=null,n=[];for(let t=0;t<e.length;t++){const[s,a]=e[t];null==r&&(r=s);for(const t of a)n.push(t);if(s.getTime()-r.getTime()>31536e6||t==e.length-1){const t=`http://localhost:38820/https://api.aeso.ca/report/v1.1/price/poolPrice?startDate=${r.getUTCFullYear().toFixed()}-${(r.getUTCMonth()+1).toFixed().padStart(2,"0")}-${r.getUTCDate().toFixed().padStart(2,"0")}&endDate=${s.getUTCFullYear().toFixed()}-${(s.getUTCMonth()+1).toFixed().padStart(2,"0")}-${s.getUTCDate().toFixed().padStart(2,"0")}`;o.set(t,n),r=null,n=[]}}const l=[];for(const[t,e]of o)l.push(new Promise((async(o,r)=>{try{console.log("Web request to ",t);const o=await fetch(t,{headers:{"X-API-Key":localStorage.getItem("aeso-api-key")??""}}),r=await o.json();for(const t of e)t.resolve&&t.resolve(r)}catch(t){for(const o of e)o.reject&&o.reject(t)}o()})));await Promise.allSettled(l)}const c="https://app.bchydro.com/mvwebbe/user/login";let i=null;async function u(t,e){try{t=t.replaceAll('"','""'),e=e.replaceAll('"','""');const o=JSON.stringify({username:t,password:e}),r=await fetch("http://localhost:38820/"+c,{method:"POST",body:o,headers:{"Content-Type":"application/json"}}),n=await r.json();return i=n.jwtToken,!0}catch(t){return console.error(t),!1}}async function d(t,e,o,r,n,s){const a=`https://app.bchydro.com/mvwebbe/rest/meterdownload?tsp=${(new Date).getTime()}&meterId=${o}&intLength=60&selectedChannelNum=1&selectedSetNum=1&calendarMonth=0&reportStart=${r.getUTCMonth()+1}/${r.getUTCDate()}/${r.getUTCFullYear()}&reportEnd=${n.getUTCMonth()+1}/${n.getUTCDate()}/${n.getUTCFullYear()}&usageOrDemand=${s}&idOrGroup=meter`;let l=!1;if(!i){if(!await u(t,e))throw new Error("Could not sign in to eMeter.");l=!0}for(;;){console.log("Sending request to "+a);const o=await fetch("http://localhost:38820/"+a,{headers:{Authorization:`Bearer ${i??""}`}});if(console.log("Status",o.status),o.ok){console.log("Fetching response body");const t=await o.json();return console.log(t),p(t)}if(l||500!==o.status&&401!==o.status)throw console.log("Error",o.status),new Error(`Error: ${o.status}`);if(!await u(t,e))throw new Error("Could not sign in to eMeter.");l=!0}}function p(t){const e=t.dnlDataParentList[0];let o="",r=0;for(const t of e)if(0!==r){for(const e of t){let t;if(void 0===(t=e))throw new Error(`Error parsing row ${r}`);2===r&&(o+="\n"),o+=t}r++}else r++;return o.split("\n").map((t=>t.split(",")))}function f(t){switch(typeof t){case"string":{const e=new Date(t);if(isNaN(e.getTime()))throw new Error(`Invalid date "${t}".`);return new Date(t)}case"number":return(e=t)<61||(e-=1),new Date(24*(e-25568)*3600*1e3)}var e}CustomFunctions.associate("AESOPOOLPRICE",(async function(t,e){try{let o=f(t);const r=await function(t){const e={resolve:null,reject:null},o=new Promise(((t,o)=>{e.resolve=t,e.reject=o})),r=s.get(t);return r?r.push(e):s.set(t,[e]),a||(a=!0,setTimeout(l,100)),o}(o),n=`${o.getUTCFullYear()}-${(o.getUTCMonth()+1).toString().padStart(2,"0")}-${o.getUTCDate().toString().padStart(2,"0")} ${(e-1).toString().padStart(2,"0")}:00`;for(const t of r.return["Pool Price Report"])if(t.begin_datetime_mpt==n)return parseFloat(t.pool_price);throw new Error("Not found.")}catch(t){throw console.error(t),t}})),CustomFunctions.associate("AESOMETEREDVOLUME",(async function(e,o,n){try{let s=f(o);const a=await async function(e,o){const n=`${o.getUTCFullYear().toFixed()}-${(o.getUTCMonth()+1).toFixed().padStart(2,"0")}-${o.getUTCDate().toFixed().padStart(2,"0")} ${o.getUTCHours().toFixed().padStart(2,"0")}:00`;for(let s=0;s<2;s++){const a=t.get(e),l=a?.get(n);if(null!=l)return l;if(0!=s)throw new Error(`Could not get metered volume at ${n} for asset ${e}.`);await r(e,o)}throw new Error(`Could not get metered volume at ${n} for asset ${e}.`)}(e,new Date(s.getTime()+36e5*(n-1)));return a}catch(t){throw console.error(t),t}})),CustomFunctions.associate("CREATEFORMATTEDNUMBER",(function(t,e){return{type:"FormattedNumber",basicValue:t,numberFormat:e}})),CustomFunctions.associate("LOGINPUT",(function(t){console.log(typeof t+":",t)})),CustomFunctions.associate("SHOWWINDOW",(function(t){Office.context.ui.displayDialogAsync(t,{promptBeforeOpen:!1,displayInIframe:!1})})),CustomFunctions.associate("BCHYDROSIGNIN",(function(t,e){return u(t,e)})),CustomFunctions.associate("BCHYDROEMETERUSAGE",(async function(t,e,o,r,n){try{return d(t,e,o,f(r),f(n),"usage")}catch(t){return console.error(t),[[t.message]]}})),CustomFunctions.associate("BCHYDROEMETERDEMAND",(async function(t,e,o,r,n){try{return d(t,e,o,f(r),f(n),"demand")}catch(t){return console.error(t),[[t.message]]}}))})();