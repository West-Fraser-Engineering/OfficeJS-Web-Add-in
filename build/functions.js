(()=>{"use strict";const t=new Map;let e=[],o=!1;function a(t,a){const r=new Promise(((o,s)=>{e.push({asset_id:t,dateTime:a,resolve:o,reject:s})}));return o||(o=!0,setTimeout(s,100)),r}async function s(){console.log("Make request called");const a=864e5,s=localStorage.getItem("aeso-api-key")??"",r=e;e=[],o=!1;const n=new Map;for(const t of r){let e=n.get(t.asset_id);null==e&&(e=new Map,n.set(t.asset_id,e));let o=e.get(t.dateTime.getTime());null==o&&(o=[],e.set(t.dateTime.getTime(),o)),o.push({resolve:t.resolve,reject:t.reject})}const l=[],c=[];for(const[e,o]of n.entries()){const r=Array.from(o.entries()).sort(((t,e)=>t[0]-e[0]));let n=null,i=null,u=[];for(let o=0;o<r.length;o++){const d=r[o][0];if(u.concat(r[o][1]),console.log("callbacks:",u),null==n&&(n=d),null==i&&(i=d),24*(Math.floor((d-n)/a)+1)>8e4||Math.floor((d-i)/a)>5||o==r.length-1){const o=new Date(n),a=new Date(d),r=o.getUTCFullYear().toFixed(),g=(o.getUTCMonth()+1).toFixed().padStart(2,"0"),f=(o.getUTCDate()+1).toFixed().padStart(2,"0"),p=a.getUTCFullYear().toFixed(),m=(a.getUTCMonth()+1).toFixed().padStart(2,"0"),h=(a.getUTCDate()+1).toFixed().padStart(2,"0");let T;T=r==p&&g==m&&f==h?`http://localhost:38820/https://api.aeso.ca/report/v1/meteredvolume/details?startDate=${r}-${g}-${f}&asset_ID=${e}`:`http://localhost:38820/https://api.aeso.ca/report/v1/meteredvolume/details?startDate=${r}-${g}-${f}&endDate=${p}-${m}-${h}&asset_ID=${e}`;const w=u;u=[],c.push(new Promise((async(e,o)=>{try{console.log("Request to",T);const o=await fetch(T,{headers:{"X-API-Key":s}}),a=await o.json();for(const e of a.return)for(const o of e.asset_list){let e=t.get(o.asset_id);null==e&&(e=new Map,t.set(o.asset_id,e));for(const t of o.metered_volume_list)e.set(t.begin_date_mpt,parseFloat(t.metered_volume))}console.log("resolving callbacks",w);for(const t of w)t.resolve();e()}catch(t){for(const e of w)e.reject(t);o(t)}}))),l.push(T),n=null,i=null}i=d}}await Promise.allSettled(c)}let r=new Map,n=!1;async function l(){n=!1;const t=new Map(r);r.clear();const e=Array.from(t.entries()).sort(((t,e)=>t[0].getTime()-e[0].getTime())),o=new Map;let a=null,s=[];for(let t=0;t<e.length;t++){const[r,n]=e[t];null==a&&(a=r);for(const t of n)s.push(t);if(r.getTime()-a.getTime()>31536e6||t==e.length-1){const t=`http://localhost:38820/https://api.aeso.ca/report/v1.1/price/poolPrice?startDate=${a.getUTCFullYear().toFixed()}-${(a.getUTCMonth()+1).toFixed().padStart(2,"0")}-${(a.getUTCDate()+1).toFixed().padStart(2,"0")}&endDate=${r.getUTCFullYear().toFixed()}-${(r.getUTCMonth()+1).toFixed().padStart(2,"0")}-${(r.getUTCDate()+1).toFixed().padStart(2,"0")}`;o.set(t,s),a=null,s=[]}}const l=[];for(const[t,e]of o)l.push(new Promise((async(o,a)=>{try{console.log("Web request to ",t);const o=await fetch(t,{headers:{"X-API-Key":localStorage.getItem("aeso-api-key")??""}}),a=await o.json();for(const t of e)t.resolve&&t.resolve(a)}catch(t){for(const o of e)o.reject&&o.reject(t)}o()})));await Promise.allSettled(l)}function c(t){switch(typeof t){case"string":{const e=new Date(t);if(isNaN(e.getTime()))throw new Error(`Invalid date "${t}".`);return new Date(t)}case"number":return(e=t)<61||(e-=1),new Date(24*(e-25568)*3600*1e3)}var e}CustomFunctions.associate("AESOPOOLPRICE",(async function(t,e){let o=c(t);const a=await function(t){const e={resolve:null,reject:null},o=new Promise(((t,o)=>{e.resolve=t,e.reject=o})),a=r.get(t);return a?a.push(e):r.set(t,[e]),n||(n=!0,setTimeout(l,100)),o}(o),s=`${o.getUTCFullYear()}-${(o.getUTCMonth()+1).toString().padStart(2,"0")}-${(o.getUTCDate()+1).toString().padStart(2,"0")} ${(e-1).toString().padStart(2,"0")}:00`;for(const t of a.return["Pool Price Report"])if(t.begin_datetime_mpt==s)return parseFloat(t.pool_price);throw new Error("Not found.")})),CustomFunctions.associate("AESOMETEREDVOLUME",(async function(e,o,s){let r=c(o);return await async function(e,o){const s=`${o.getUTCFullYear().toFixed()}-${(o.getUTCMonth()+1).toFixed().padStart(2,"0")}-${(o.getUTCDate()+1).toFixed().padStart(2,"0")} ${o.getUTCHours().toFixed().padStart(2,"0")}:00`;for(let r=0;r<2;r++){const n=t.get(e),l=n?.get(s);if(null!=l)return l;if(0!=r)throw new Error(`Could not get metered volume at ${s} for asset ${e}.`);await a(e,o)}throw new Error(`Could not get metered volume at ${s} for asset ${e}.`)}(e,new Date(r.getTime()+36e5*(s-1)))})),CustomFunctions.associate("CREATEFORMATTEDNUMBER",(function(t,e){return{type:"FormattedNumber",basicValue:t,numberFormat:e}})),CustomFunctions.associate("LOGINPUT",(function(t){console.log(typeof t+":",t)}))})();